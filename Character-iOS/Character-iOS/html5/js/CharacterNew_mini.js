function Character(d){this.option={containerId:"container",content:null,attribute:{canvasId:"cs1",size:480,fontColor:"lightgray",blkColor:"#FF0000",frameMode:0,imageName:"",backgroundColor:"#eaeff1",borderColor:"#6e95B3",borderWidth:1}};this.step=4;this.Ri=0;this.Ti=0;this.CurStep=1;this.timer=null;this.from=0;this.to=0;this.subMode=false;this.radicals_begin=0;this.radicals_end=0;this.phonogram_begin=0;this.phonogram_end=0;this.symbol_begin=0;this.symbol_end=0;this.stepMode=false;this.beComplete=false;var e=JSON.parse(d.content[0]);for(var c=1,b=d.content.length;c<b;c++){e=$.extend(true,e,JSON.parse(d.content[c]))}var a=$.extend(true,{},d);a.content=e;if(a.content.attribute){this.radicals_begin=a.content.attribute.radicals.begin;this.radicals_end=a.content.attribute.radicals.end;if(a.content.attribute.phonogram){this.phonogram_begin=a.content.attribute.phonogram.begin;this.phonogram_end=a.content.attribute.phonogram.end;this.symbol_begin=a.content.attribute.symbol.begin;this.symbol_end=a.content.attribute.symbol.end}}this.option=$.extend(true,this.option,a)}Character.prototype={constructor:Character,init:function(d){var g=this,f=document.getElementById(g.option.attribute.canvasId),c=g.option.attribute.size;if(f&&f.getContext){f.getContext("2d").clearRect(0,0,c,c)}else{$("#"+g.option.containerId).append('<div id="main"><canvas id="'+g.option.attribute.canvasId+'" width="'+c+'" height="'+c+'" style="cursor:default;">您的浏览器不支持canvas!</canvas></div><div id="strokes"></div>')}f=document.getElementById(g.option.attribute.canvasId);var b=f.getContext("2d");b.fillStyle=g.option.attribute.backgroundColor;b.strokeStyle=g.option.attribute.borderColor;b.lineWidth=g.option.attribute.borderWidth;if(g.option.attribute.imageName){var e=new Image();e.src=g.option.attribute.imageName;e.onload=function(){b.drawImage(e,0,0,c,c);h()}}else{switch(g.option.attribute.frameMode){case 0:break;case 1:a(1);break;case 2:a(2);break;default:throw new Error("错误的背景参数！")}h()}$(f).off(".canvas").on("click.canvas tap.canvas",function(i){if(g.beComplete){return}g.playCharacter();return false});function a(l){b.save();var i=Math.ceil(g.option.attribute.borderWidth/2),k=c-i*2;b.fillRect(i,i,k,k);b.strokeRect(i,i,k,k);b.globalCompositionOperation="destination-over";c=g.option.attribute.size;var j=c/2;b.beginPath();b.moveTo(j,0);b.lineTo(j,c);b.moveTo(0,j);b.lineTo(c,j);if(l==2){b.moveTo(0,0);b.lineTo(c,c);b.moveTo(c,0);b.lineTo(0,c)}b.stroke();b.restore()}function h(){b.save();var q=g.option.content.size,o=g.option.attribute.fontColor;b.scale(c/q,c/q);b.strokeStyle=o;b.fillStyle=o;b.lineWidth=0;b.beginPath();for(var n=0,k=g.option.content.points.length;n<k;n++){var r=g.option.content.points[n];for(var m=0;m<r.R.length;m++){if(r.R[m].t==0){b.moveTo(r.R[m].x,r.R[m].y)}else{if(r.R[m].t==1){b.lineTo(r.R[m].x,r.R[m].y)}else{b.bezierCurveTo(r.R[m].cx1,r.R[m].cy1,r.R[m].cx2,r.R[m].cy2,r.R[m].x,r.R[m].y)}}}}b.fill();b.stroke();b.closePath();b.restore()}},playCharacter:function(){var b=this,d=document.getElementById(b.option.attribute.canvasId),c=b.option.attribute.size,e=b.option.content.size;if(d.getContext){var a=d.getContext("2d");clearInterval(b.timer);b.timer=setInterval(function(){if(b.Ti==0&&b.CurStep==1&&b.Ri!=b.option.content.points.length){$(document).trigger("stepbegin",b.Ri+1)}if(b.Ri<b.from-1){b.Ri+=1;b.CurStep=1;return}if(b.Ri==b.option.content.points.length){b.Ri=0;b.Ti=0;b.CurStep=1;b.beComplete=true;clearInterval(b.timer);return}if(b.Ti==b.option.content.points[b.Ri].T.length-1){b.Ri+=1;b.Ti=0;b.CurStep=1;if((b.subMode&&b.Ri==b.to)||b.stepMode){clearInterval(b.timer)}if(b.Ri==b.option.content.points.length){$(document).trigger("complete")}else{$(document).trigger("stepend",b.Ri)}return}a.save();a.scale(c/e,c/e);var o=b.option.content.points[b.Ri];a.beginPath();for(var k=0;k<o.R.length;k++){if(o.R[k].t==0){a.moveTo(o.R[k].x,o.R[k].y)}else{if(o.R[k].t==1){a.lineTo(o.R[k].x,o.R[k].y)}else{a.bezierCurveTo(o.R[k].cx1,o.R[k].cy1,o.R[k].cx2,o.R[k].cy2,o.R[k].x,o.R[k].y)}}}a.closePath();a.clip();var m=b.Ti+1;var f=Math.sqrt((parseInt(o.T[b.Ti].x)-parseInt(o.T[m].x))*(parseInt(o.T[b.Ti].x)-parseInt(o.T[m].x))+(parseInt(o.T[b.Ti].y)-parseInt(o.T[m].y))*(parseInt(o.T[b.Ti].y)-parseInt(o.T[m].y)));var i=Math.floor(f/b.step);var n=(parseInt(o.T[m].x)-parseInt(o.T[b.Ti].x))/i;var h=(parseInt(o.T[m].y)-parseInt(o.T[b.Ti].y))/i;var g={x:parseInt(o.T[b.Ti].x)+b.CurStep*n,y:parseInt(o.T[b.Ti].y)+b.CurStep*h};a.strokeStyle=b.option.attribute.blkColor;a.lineWidth=75;a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(parseInt(o.T[b.Ti].x),parseInt(o.T[b.Ti].y));a.lineTo(parseInt(g.x),parseInt(g.y));a.stroke();b.CurStep+=1;if(b.CurStep>i){b.Ti+=1;b.CurStep=1}a.restore()},10)}},createSplit:function(k){var p=this,s={containerId:"strokes",content:null,attribute:{canvasId:"cs",size:70,fontColor:"lightgray",blkColor:"#FF0000",frameMode:2,imageName:"mybg.jpg",backgroundColor:"#eaeff1",borderColor:"#6e95B3",borderWidth:1}};var a=JSON.parse(k.content[0]);for(var f=1,b=k.content.length;f<b;f++){a=$.extend(true,a,JSON.parse(k.content[f]))}k.content=a;k=$.extend(true,s,k);$("#strokes").empty();for(var f=0,b=k.content.points.length;f<b;f++){var d=k.attribute.canvasId+f;$("#"+k.containerId).append('<canvas id="'+d+'" width="'+k.attribute.size+'" height="'+k.attribute.size+'" style="cursor:default;">您的浏览器不支持canvas!</canvas>');var e=document.getElementById(d),g=[];for(var c=0;c<f+1;c++){g.push(k.content.points[c])}var n={unicode:p.option.content.characters,size:p.option.content.size,points:g};if(e.getContext){var u=e.getContext("2d"),r=k.attribute,v=k.attribute.size;u.clearRect(0,0,r.size,r.size);u.fillStyle=k.attribute.backgroundColor;u.strokeStyle=k.attribute.borderColor;u.lineWidth=k.attribute.borderWidth;u.save();if(r.backgroundColor){u.fillStyle=r.backgroundColor;u.fillRect(0,0,r.size,r.size)}u.restore();if(k.attribute.imageName){var m=new Image();m.src=k.attribute.imageName;m.onload=(function(h,i){return function(){h.drawImage(m,0,0,v,v);t(h,i)}})(u,n)}else{switch(k.attribute.frameMode){case 0:break;case 1:q(1);break;case 2:q(2);break;default:throw new Error("错误的背景参数！")}t(u,n)}function q(l){u.save();var h=Math.ceil(k.attribute.borderWidth/2),j=v-h*2;u.fillRect(h,h,j,j);u.strokeRect(h,h,j,j);v=k.attribute.size;var i=v/2;u.beginPath();u.moveTo(i,0);u.lineTo(i,v);u.moveTo(0,i);u.lineTo(v,i);if(l==2){u.moveTo(0,0);u.lineTo(v,v);u.moveTo(v,0);u.lineTo(0,v)}u.stroke();u.restore()}function t(o,A){o.save();var z=k.content.size,y=k.attribute.blkColor;o.scale(v/z,v/z);o.strokeStyle=y;o.fillStyle=y;o.lineWidth=0;o.beginPath();for(var x=0,h=A.points.length;x<h;x++){var B=k.content.points[x];for(var w=0;w<B.R.length;w++){if(B.R[w].t==0){o.moveTo(B.R[w].x,B.R[w].y)}else{if(B.R[w].t==1){o.lineTo(B.R[w].x,B.R[w].y)}else{o.bezierCurveTo(B.R[w].cx1,B.R[w].cy1,B.R[w].cx2,B.R[w].cy2,B.R[w].x,B.R[w].y)}}}}o.fill();o.stroke();o.closePath();o.restore()}}}},setPlayMode:function(c,b){var a=this;if(c==0){a.subMode=false;a.stepMode=false}else{if(c==1){a.subMode=true;a.stepMode=false;if(b==0){a.from=a.radicals_begin;a.to=a.radicals_end}else{if(b==1){a.from=a.phonogram_begin;a.to=a.phonogram_end}else{if(b==2){a.from=a.symbol_begin;a.to=a.symbol_end}}}}else{if(c==2){a.subMode=false;a.stepMode=true}}}}};